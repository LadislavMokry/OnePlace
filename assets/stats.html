<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OnePlace Stats</title>
    <style>
      :root {
        --bg: #f7f2ea;
        --panel: #fff8ef;
        --text: #2b2118;
        --muted: #8b7b6a;
        --border: #e1d5c7;
        --accent: #b5532a;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Georgia", "Times New Roman", serif;
        margin: 0;
        background: var(--bg);
        color: var(--text);
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        background: #fff;
      }
      h1 {
        margin: 0;
        font-size: 22px;
        letter-spacing: 0.3px;
      }
      main {
        padding: 20px 24px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      select, button {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px 10px;
        background: #fff;
      }
      button {
        background: var(--accent);
        color: white;
        border: 0;
        cursor: pointer;
      }
      .secondary {
        background: #f2e7da;
        color: #3a2f26;
      }
      a.secondary {
        display: inline-block;
        text-decoration: none;
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th, td {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid var(--border);
      }
      .small { font-size: 12px; }
      .muted { color: var(--muted); }
    </style>
  </head>
  <body>
    <header>
      <h1>OnePlace Stats</h1>
      <a class="secondary" href="/">Back to Admin</a>
    </header>
    <main>
      <section class="panel">
        <div class="row">
          <label class="small">Project</label>
          <select id="projectSelect"></select>
          <button id="refresh" class="secondary">Refresh</button>
        </div>
        <div class="small muted" id="projectMeta">No project selected.</div>
      </section>

      <section class="panel">
        <h2>Source Hit Rate</h2>
        <table>
          <thead>
            <tr>
              <th>Source</th>
              <th>Total</th>
              <th>Used in Audio</th>
              <th>Hit Rate</th>
              <th>Avg Score</th>
              <th>Last Scraped</th>
            </tr>
          </thead>
          <tbody id="statsBody"></tbody>
        </table>
      </section>

      <section class="panel">
        <h2>YouTube Analytics (last 7 days)</h2>
        <div class="small muted" id="youtubeMeta">No YouTube data yet.</div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Views</th>
              <th>Watch (min)</th>
              <th>Avg View (sec)</th>
              <th>Likes</th>
              <th>Comments</th>
              <th>Subs Gained</th>
            </tr>
          </thead>
          <tbody id="youtubeBody"></tbody>
          <tfoot id="youtubeFooter"></tfoot>
        </table>
      </section>

      <section class="panel">
        <h2>YouTube Video Checkpoints</h2>
        <div class="small muted" id="youtubeVideoMeta">No video checkpoints yet.</div>
        <table>
          <thead>
            <tr>
              <th>Video</th>
              <th>Posted</th>
              <th>Checkpoint</th>
              <th>Views</th>
              <th>Likes</th>
              <th>Comments</th>
              <th>Watch (min)</th>
              <th>Avg View (sec)</th>
              <th>Script LLM</th>
              <th>TTS Model</th>
              <th>Voice</th>
            </tr>
          </thead>
          <tbody id="youtubeVideoBody"></tbody>
        </table>
      </section>
    </main>
    <script>
      const dom = {
        projectSelect: document.getElementById("projectSelect"),
        statsBody: document.getElementById("statsBody"),
        projectMeta: document.getElementById("projectMeta"),
        refresh: document.getElementById("refresh"),
        youtubeBody: document.getElementById("youtubeBody"),
        youtubeFooter: document.getElementById("youtubeFooter"),
        youtubeMeta: document.getElementById("youtubeMeta"),
        youtubeVideoBody: document.getElementById("youtubeVideoBody"),
        youtubeVideoMeta: document.getElementById("youtubeVideoMeta")
      };

      async function api(path, options = {}) {
        const res = await fetch(path, {
          headers: { "Content-Type": "application/json" },
          ...options
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || res.statusText);
        }
        return res.json();
      }

      function formatDate(value) {
        return value ? value.split("T")[0] : "-";
      }

      function fmtInt(value) {
        if (value === null || value === undefined) return "-";
        return Number(value).toLocaleString();
      }

      function fmtFloat(value, digits = 1) {
        if (value === null || value === undefined) return "-";
        return Number(value).toFixed(digits);
      }

      async function loadProjects() {
        const projects = await api("/api/projects");
        dom.projectSelect.innerHTML = "";
        projects.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          dom.projectSelect.appendChild(opt);
        });
        if (projects.length) {
          dom.projectSelect.value = projects[0].id;
          await loadStats();
        }
      }

      async function loadStats() {
        const projectId = dom.projectSelect.value;
        if (!projectId) return;
        const data = await api(`/api/projects/${projectId}/stats`);
        const rows = data.sources || [];
        const ytRows = data.youtube_metrics || [];
        const ytVideoRows = data.youtube_video_metrics || [];
        const channelTitle = data.youtube_channel_title || "";
        dom.projectMeta.textContent = `Sources: ${rows.length}`;
        dom.statsBody.innerHTML = "";
        if (!rows.length) {
          dom.statsBody.innerHTML = "<tr><td colspan='6' class='small muted'>No data yet.</td></tr>";
        } else {
          rows.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.source_name || "-"}</td>
              <td class="small">${row.total_articles}</td>
              <td class="small">${row.used_in_audio}</td>
              <td class="small">${row.hitrate}%</td>
              <td class="small">${row.avg_score ?? "-"}</td>
              <td class="small">${formatDate(row.last_scraped_at)}</td>
            `;
            dom.statsBody.appendChild(tr);
          });
        }

        dom.youtubeBody.innerHTML = "";
        dom.youtubeFooter.innerHTML = "";
        if (channelTitle) {
          dom.youtubeMeta.textContent = `Channel: ${channelTitle}`;
        } else {
          dom.youtubeMeta.textContent = "Channel not connected.";
        }
        if (!ytRows.length) {
          dom.youtubeBody.innerHTML = "<tr><td colspan='7' class='small muted'>No YouTube data yet.</td></tr>";
          return;
        }
        let totalViews = 0;
        let totalWatch = 0;
        let totalLikes = 0;
        let totalComments = 0;
        let totalSubs = 0;
        let weightedDuration = 0;
        ytRows.forEach((row) => {
          const views = Number(row.views || 0);
          const watch = Number(row.watch_time_minutes || 0);
          const avgDur = Number(row.average_view_duration_seconds || 0);
          totalViews += views;
          totalWatch += watch;
          totalLikes += Number(row.likes || 0);
          totalComments += Number(row.comments || 0);
          totalSubs += Number(row.subscribers_gained || 0);
          weightedDuration += avgDur * views;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="small">${formatDate(row.report_date)}</td>
            <td class="small">${fmtInt(row.views)}</td>
            <td class="small">${fmtFloat(row.watch_time_minutes)}</td>
            <td class="small">${fmtFloat(row.average_view_duration_seconds, 0)}s</td>
            <td class="small">${fmtInt(row.likes)}</td>
            <td class="small">${fmtInt(row.comments)}</td>
            <td class="small">${fmtInt(row.subscribers_gained)}</td>
          `;
          dom.youtubeBody.appendChild(tr);
        });
        const avgDuration = totalViews ? weightedDuration / totalViews : 0;
        dom.youtubeFooter.innerHTML = `
          <tr>
            <td class="small"><strong>Total</strong></td>
            <td class="small"><strong>${fmtInt(totalViews)}</strong></td>
            <td class="small"><strong>${fmtFloat(totalWatch)}</strong></td>
            <td class="small"><strong>${fmtFloat(avgDuration, 0)}s</strong></td>
            <td class="small"><strong>${fmtInt(totalLikes)}</strong></td>
            <td class="small"><strong>${fmtInt(totalComments)}</strong></td>
            <td class="small"><strong>${fmtInt(totalSubs)}</strong></td>
          </tr>
        `;

        dom.youtubeVideoBody.innerHTML = "";
        if (!ytVideoRows.length) {
          dom.youtubeVideoMeta.textContent = "No video checkpoints yet.";
          dom.youtubeVideoBody.innerHTML =
            "<tr><td colspan='11' class='small muted'>No data yet.</td></tr>";
          return;
        }
        dom.youtubeVideoMeta.textContent = `Rows: ${ytVideoRows.length}`;
        ytVideoRows.forEach((row) => {
          const title = row.title || "Audio Roundup";
          const link = row.post_url ? `<a href='${row.post_url}' target='_blank'>${title}</a>` : title;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="small">${link}</td>
            <td class="small">${formatDate(row.posted_at)}</td>
            <td class="small">${row.checkpoint || "-"}</td>
            <td class="small">${fmtInt(row.views)}</td>
            <td class="small">${fmtInt(row.likes)}</td>
            <td class="small">${fmtInt(row.comments)}</td>
            <td class="small">${fmtFloat(row.watch_time_minutes)}</td>
            <td class="small">${fmtFloat(row.average_view_duration_seconds, 0)}s</td>
            <td class="small">${row.script_model || row.generating_model || "-"}</td>
            <td class="small">${row.tts_model || "-"}</td>
            <td class="small">${row.tts_voice || "-"}</td>
          `;
          dom.youtubeVideoBody.appendChild(tr);
        });
      }

      dom.projectSelect.onchange = loadStats;
      dom.refresh.onclick = loadStats;

      loadProjects().catch((err) => {
        console.error(err);
        dom.projectMeta.textContent = "Failed to load projects.";
      });
    </script>
  </body>
</html>
