<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OnePlace Admin</title>
    <style>
      :root {
        --bg: #f3efe4;
        --panel: #fffdf7;
        --ink: #2a2a2a;
        --muted: #6d6257;
        --accent: #2f6f6d;
        --accent-2: #b84e4e;
        --border: #e4dccd;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Georgia, "Times New Roman", serif;
        color: var(--ink);
        background: radial-gradient(circle at 20% 20%, #f8f4ea 0%, var(--bg) 60%);
      }
      header {
        padding: 18px 24px;
        border-bottom: 1px solid var(--border);
        background: #f9f6ee;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      header h1 {
        margin: 0;
        font-size: 22px;
        letter-spacing: 0.4px;
      }
      main {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 16px;
        padding: 16px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
      }
      .panel h2 {
        margin: 0 0 8px;
        font-size: 16px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .projects-list button {
        width: 100%;
        text-align: left;
        padding: 8px 10px;
        margin-bottom: 6px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
      }
      .projects-list button.active {
        border-color: var(--accent);
        background: #e8f1f0;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      input, select, textarea {
        padding: 6px 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-family: inherit;
      }
      textarea {
        width: 100%;
        min-height: 80px;
      }
      button.primary {
        background: var(--accent);
        color: white;
        border: 0;
        border-radius: 8px;
        padding: 8px 10px;
        cursor: pointer;
      }
      button.secondary {
        background: #f2e7da;
        color: #3a2f26;
        border: 0;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
      }
      a.secondary {
        display: inline-block;
        background: #f2e7da;
        color: #3a2f26;
        border-radius: 8px;
        padding: 6px 10px;
        text-decoration: none;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th, td {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid var(--border);
      }
      .muted {
        color: var(--muted);
      }
      .status-pill {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 12px;
        background: #efe7da;
      }
      .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #efe7da;
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
        margin-left: 6px;
      }
      .spinner.hidden {
        display: none;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .items {
        max-height: 240px;
        overflow: auto;
        border: 1px dashed var(--border);
        padding: 8px;
        border-radius: 8px;
        background: #fff;
      }
      .items-row td {
        padding: 0;
      }
      .items-panel {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
        margin: 8px 0 12px;
        background: #fff;
      }
      .auth-panel {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
        margin: 8px 0 12px;
        background: #fff;
      }
      .items-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .item-card {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        background: #fbf7ef;
      }
      .item-card .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }
      .item-card .excerpt {
        margin-top: 8px;
        white-space: pre-wrap;
      }
      .items .item {
        padding: 6px 0;
        border-bottom: 1px solid var(--border);
      }
      .items .item:last-child {
        border-bottom: none;
      }
      .small {
        font-size: 12px;
      }
      .warn {
        color: var(--accent-2);
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>OnePlace Admin</h1>
      <div class="row">
        <a class="secondary" href="/stats">Stats</a>
        <button class="secondary" id="refresh">Refresh</button>
      </div>
    </header>
    <main>
      <section class="panel">
        <h2>Projects</h2>
        <div class="projects-list" id="projects"></div>
        <div class="row">
          <input id="projectName" placeholder="Project name" />
          <button class="primary" id="createProject">Add</button>
        </div>
        <div class="row" style="margin-top: 8px;">
          <label class="small" style="min-width: 100px;">Language</label>
          <select id="projectLanguage" style="max-width: 200px;">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="sk">Slovakian</option>
          </select>
        </div>
        <div class="row">
          <label class="small" style="min-width: 100px;">Post</label>
          <input
            id="projectGenInterval"
            type="number"
            min="1"
            step="1"
            placeholder="12"
            style="max-width: 200px;"
          />
          <span class="small muted">hours</span>
        </div>
        <div class="row">
          <label class="small" style="min-width: 100px;">Minimal score</label>
          <input
            id="projectUnusableScore"
            type="number"
            min="1"
            max="10"
            step="1"
            placeholder="5"
            style="max-width: 200px;"
          />
        </div>
        <div class="row">
          <label class="small" style="min-width: 100px;">Unusable age</label>
          <input
            id="projectUnusableAge"
            type="number"
            min="1"
            step="1"
            placeholder="48"
            style="max-width: 200px;"
          />
          <span class="small muted">hours</span>
        </div>
        <div class="row">
          <button class="secondary" id="saveProject">Save Settings</button>
          <button class="secondary" id="deleteProject">Delete Project</button>
        </div>
        <div class="small muted" id="projectSummary">No project selected.</div>
        <div class="small muted">One project = one topic or channel.</div>
      </section>

      <section class="panel">
        <h2>Sources</h2>
        <div class="row">
          <button class="primary" id="scrapeAll">Scrape All</button>
          <span id="scrapeAllSpinner" class="spinner hidden" aria-label="Scraping"></span>
          <button class="secondary" id="checkAll">Check All</button>
          <span id="checkAllSpinner" class="spinner hidden" aria-label="Checking"></span>
          <button class="secondary" id="runPipeline">Run Pipeline</button>
          <span id="runPipelineSpinner" class="spinner hidden" aria-label="Pipeline"></span>
          <span class="small muted" id="pipelineStatus">Idle.</span>
          <span class="small muted" id="projectLabel">No project selected</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>URL</th>
              <th>Last</th>
              <th>Every (hrs)</th>
              <th>Status</th>
              <th>Auth</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="sources"></tbody>
        </table>
        <div class="row" style="margin-top: 8px;">
          <input id="sourceName" placeholder="Source name" />
          <select id="sourceType">
            <option value="rss">rss</option>
            <option value="page">page</option>
            <option value="reddit">reddit</option>
            <option value="youtube">youtube</option>
          </select>
          <input id="sourceUrl" placeholder="https://..." style="flex: 1 1 260px;" />
          <input
            id="sourceInterval"
            type="number"
            min="1"
            step="1"
            placeholder="Scrape hrs"
            style="max-width: 120px;"
          />
          <button class="primary" id="addSource">Add Source</button>
        </div>
        <div class="small muted">For YouTube: use channel RSS URL. For Reddit: use /r/name/.rss</div>
      </section>

      <section class="panel">
        <h2>Latest Items</h2>
        <div class="items" id="items">
          <div class="muted small">Click “View” on a source to expand items inline.</div>
        </div>
      </section>

      <section class="panel">
        <h2>Articles & Scores</h2>
        <div class="row">
          <button class="secondary" id="refreshArticles">Refresh</button>
          <label class="small">Show</label>
          <select id="articlesLimit">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <label class="small">Order</label>
          <select id="articlesOrder">
            <option value="score">score</option>
            <option value="age">age</option>
            <option value="status">status</option>
          </select>
          <select id="articlesDirection">
            <option value="desc">desc</option>
            <option value="asc">asc</option>
          </select>
          <button class="secondary" id="articlesPrev">Prev</button>
          <button class="secondary" id="articlesNext">Next</button>
          <span class="small muted" id="articlesPage">1 / 1</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Score</th>
              <th>Age</th>
              <th>Status</th>
              <th>Used</th>
            </tr>
          </thead>
          <tbody id="articles"></tbody>
        </table>
      </section>

      <section class="panel">
        <h2>YouTube (V1)</h2>
        <div class="small muted">Store a refresh token per project (OAuth setup later).</div>
        <div class="row" style="margin-top: 8px;">
          <input id="ytChannel" placeholder="Channel title (optional)" />
          <input id="ytToken" placeholder="Refresh token" style="flex: 1 1 260px;" />
          <button class="primary" id="saveYoutube">Save</button>
        </div>
        <div id="ytStatus" class="small muted"></div>
      </section>

      <section class="panel">
        <h2>Audio Roundup</h2>
        <div class="small muted">Generate script in project language, render audio for Spotify, and render video for YouTube.</div>
        <div class="row" style="margin-top: 8px;">
          <button class="primary" id="generateRoundup">Generate Script</button>
          <button class="secondary" id="renderRoundup">Render Audio</button>
          <button class="secondary" id="renderRoundupVideo">Render Video</button>
          <div id="roundupStatus" class="small muted"></div>
        </div>
        <img id="roundupImage" alt="Roundup image preview" style="width: 100%; max-height: 240px; object-fit: cover; margin-top: 8px; display: none;" />
        <audio id="roundupAudio" controls style="width: 100%; margin-top: 8px;"></audio>
        <video id="roundupVideo" controls style="width: 100%; margin-top: 8px; display: none;"></video>
      </section>
    </main>
    <script>
      const state = {
        projects: [],
        sources: [],
        currentProject: null,
        currentSource: null,
        currentAuthSource: null,
        currentRoundup: null,
        articlesOffset: 0,
        articlesLimit: 20
      };
      const dom = {
        projects: document.getElementById("projects"),
        projectName: document.getElementById("projectName"),
        projectLanguage: document.getElementById("projectLanguage"),
        projectGenInterval: document.getElementById("projectGenInterval"),
        projectUnusableScore: document.getElementById("projectUnusableScore"),
        projectUnusableAge: document.getElementById("projectUnusableAge"),
        projectLabel: document.getElementById("projectLabel"),
        projectSummary: document.getElementById("projectSummary"),
        sources: document.getElementById("sources"),
        sourceName: document.getElementById("sourceName"),
        sourceType: document.getElementById("sourceType"),
        sourceUrl: document.getElementById("sourceUrl"),
        sourceInterval: document.getElementById("sourceInterval"),
        items: document.getElementById("items"),
        articles: document.getElementById("articles"),
        articlesLimit: document.getElementById("articlesLimit"),
        articlesOrder: document.getElementById("articlesOrder"),
        articlesDirection: document.getElementById("articlesDirection"),
        articlesPrev: document.getElementById("articlesPrev"),
        articlesNext: document.getElementById("articlesNext"),
        articlesPage: document.getElementById("articlesPage"),
        ytChannel: document.getElementById("ytChannel"),
        ytToken: document.getElementById("ytToken"),
        ytStatus: document.getElementById("ytStatus"),
        roundupStatus: document.getElementById("roundupStatus"),
        roundupImage: document.getElementById("roundupImage"),
        roundupAudio: document.getElementById("roundupAudio"),
        roundupVideo: document.getElementById("roundupVideo"),
        createProject: document.getElementById("createProject"),
        addSource: document.getElementById("addSource"),
        scrapeAll: document.getElementById("scrapeAll"),
        scrapeAllSpinner: document.getElementById("scrapeAllSpinner"),
        checkAll: document.getElementById("checkAll"),
        checkAllSpinner: document.getElementById("checkAllSpinner"),
        runPipeline: document.getElementById("runPipeline"),
        runPipelineSpinner: document.getElementById("runPipelineSpinner"),
        pipelineStatus: document.getElementById("pipelineStatus"),
        refreshArticles: document.getElementById("refreshArticles"),
        saveYoutube: document.getElementById("saveYoutube"),
        saveProject: document.getElementById("saveProject"),
        deleteProject: document.getElementById("deleteProject"),
        generateRoundup: document.getElementById("generateRoundup"),
        renderRoundup: document.getElementById("renderRoundup"),
        renderRoundupVideo: document.getElementById("renderRoundupVideo"),
        refresh: document.getElementById("refresh")
      };

      async function api(path, options = {}) {
        const res = await fetch(path, {
          headers: { "Content-Type": "application/json" },
          ...options
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || res.statusText);
        }
        return res.headers.get("content-type")?.includes("application/json")
          ? res.json()
          : res.text();
      }

      function escapeHtml(value) {
        return String(value ?? "").replace(/[&<>"']/g, (char) => {
          const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;"
          };
          return map[char] || char;
        });
      }

      function formatDate(value) {
        return value ? value.split("T")[0] : "-";
      }

      function parsePositiveNumber(raw, label) {
        if (raw === "") return null;
        const parsed = Number(raw);
        if (!Number.isFinite(parsed) || parsed <= 0) {
          alert(`${label} must be a number > 0.`);
          return undefined;
        }
        return parsed;
      }

      function parseScore(raw, label) {
        if (raw === "") return null;
        const parsed = Number(raw);
        if (!Number.isFinite(parsed) || parsed < 1 || parsed > 10) {
          alert(`${label} must be between 1 and 10.`);
          return undefined;
        }
        return parsed;
      }

      function ageLabel(value) {
        if (!value) return "-";
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return "-";
        const diffMs = Date.now() - dt.getTime();
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        if (hours < 24) return `${hours}h`;
        const days = Math.floor(hours / 24);
        return `${days}d`;
      }

      function languageLabel(code) {
        const map = { en: "English", es: "Spanish", sk: "Slovakian" };
        return map[code] || code || "-";
      }

      function renderProjectSummary(project) {
        if (!project) {
          dom.projectSummary.textContent = "No project selected.";
          return;
        }
        const lang = languageLabel(project.language || dom.projectLanguage.value);
        const interval = project.generation_interval_hours ?? dom.projectGenInterval.value ?? "-";
        const score = project.unusable_score_threshold ?? dom.projectUnusableScore.value ?? "-";
        const age = project.unusable_age_hours ?? dom.projectUnusableAge.value ?? "-";
        dom.projectSummary.textContent = `Language: ${lang} · Post: ${interval} hours · Minimal score: ${score} · Unusable age: ${age} hours`;
      }

      function renderProjects() {
        dom.projects.innerHTML = "";
        state.projects.forEach((p) => {
          const btn = document.createElement("button");
          btn.textContent = p.name;
          if (state.currentProject && state.currentProject.id === p.id) {
            btn.classList.add("active");
          }
          btn.onclick = () => selectProject(p);
          dom.projects.appendChild(btn);
        });
      }

      function renderSources() {
        dom.sources.innerHTML = "";
        state.sources.forEach((s) => {
          const tr = document.createElement("tr");
          tr.dataset.sourceId = s.id;
          const authRequired = Boolean(s.config && s.config.auth_required);
          const authStatus = s.config && s.config.auth_last_check_status;
          const authReason = s.config && s.config.auth_last_check_reason;
          const authLabel = authRequired
            ? `login${authReason ? ` (${escapeHtml(authReason)})` : ""}`
            : authStatus === "ok"
              ? "ok"
              : "-";
          tr.innerHTML = `
            <td>${escapeHtml(s.name)}</td>
            <td>${escapeHtml(s.source_type)}</td>
            <td class="small">${escapeHtml(s.url)}</td>
            <td class="small">${formatDate(s.last_scraped_at)}</td>
            <td class="small">${s.scrape_interval_hours ?? "-"}</td>
            <td><span class="status-pill">${escapeHtml(s.last_status || "idle")}</span></td>
            <td class="small">${authLabel}</td>
            <td>
              <button class="secondary" data-action="scrape" data-id="${s.id}">Scrape</button>
              <button class="secondary" data-action="view" data-id="${s.id}">View</button>
              <button class="secondary" data-action="login" data-id="${s.id}">Login</button>
              <button class="secondary" data-action="edit" data-id="${s.id}">Edit</button>
            </td>
          `;
          dom.sources.appendChild(tr);
        });
      }

      async function loadProjects() {
        state.projects = await api("/api/projects");
        if (state.currentProject) {
          const match = state.projects.find((p) => p.id === state.currentProject.id);
          state.currentProject = match || null;
        }
        if (!state.currentProject && state.projects.length) {
          await selectProject(state.projects[0]);
          return;
        }
        renderProjects();
        if (state.currentProject) {
          dom.projectLabel.textContent = state.currentProject.name;
          renderProjectSummary(state.currentProject);
          await Promise.all([loadSources(), loadYoutube(), loadArticles()]);
        } else {
          dom.projectLabel.textContent = "No project selected";
          dom.sources.innerHTML = "";
          closeInlinePanels();
          dom.articles.innerHTML = "<tr><td colspan='5' class='small muted'>No project selected.</td></tr>";
          renderProjectSummary(null);
        }
      }

      async function selectProject(project) {
        state.currentProject = project;
        dom.projectLabel.textContent = project.name;
        const langValue = ["en", "es", "sk"].includes(project.language)
          ? project.language
          : "en";
        dom.projectLanguage.value = langValue;
        dom.projectGenInterval.value = project.generation_interval_hours || "";
        dom.projectUnusableScore.value = project.unusable_score_threshold || "";
        dom.projectUnusableAge.value = project.unusable_age_hours || "";
        renderProjectSummary(project);
        renderProjects();
        await Promise.all([loadSources(), loadYoutube(), loadArticles()]);
      }

      async function loadSources() {
        if (!state.currentProject) return;
        state.sources = await api(`/api/projects/${state.currentProject.id}/sources`);
        renderSources();
        closeInlinePanels();
      }

      async function addProject() {
        const name = dom.projectName.value.trim();
        if (!name) return;
        await api("/api/projects", { method: "POST", body: JSON.stringify({ name }) });
        dom.projectName.value = "";
        await loadProjects();
      }

      async function addSource() {
        if (!state.currentProject) return;
        const name = dom.sourceName.value.trim();
        const source_type = dom.sourceType.value;
        const url = dom.sourceUrl.value.trim();
        const intervalRaw = dom.sourceInterval.value.trim();
        const scrape_interval_hours = parsePositiveNumber(intervalRaw, "Scrape interval");
        if (scrape_interval_hours === undefined) return;
        if (!name || !url) return;
        await api(`/api/projects/${state.currentProject.id}/sources`, {
          method: "POST",
          body: JSON.stringify({
            name,
            source_type,
            url,
            enabled: true,
            scrape_interval_hours
          })
        });
        dom.sourceName.value = "";
        dom.sourceUrl.value = "";
        dom.sourceInterval.value = "";
        await loadSources();
      }

      async function scrapeAll() {
        if (!state.currentProject) return;
        dom.scrapeAll.disabled = true;
        dom.scrapeAllSpinner.classList.remove("hidden");
        const originalLabel = dom.scrapeAll.textContent;
        dom.scrapeAll.textContent = "Scraping...";
        try {
          await api(`/api/projects/${state.currentProject.id}/scrape`, { method: "POST" });
        } finally {
          dom.scrapeAll.disabled = false;
          dom.scrapeAllSpinner.classList.add("hidden");
          dom.scrapeAll.textContent = originalLabel;
          await loadSources();
        }
      }

      async function scrapeSource(sourceId) {
        await api(`/api/sources/${sourceId}/scrape`, { method: "POST" });
        await loadSources();
      }

      async function checkSourceAccess(sourceId) {
        const result = await api(`/api/sources/${sourceId}/check-access`, { method: "POST" });
        if (result.status === "login_required") {
          alert(`Login likely required (${result.reason || "detected"}). Use Login to add credentials.`);
        } else if (result.status === "ok") {
          alert("Access looks OK for sampled articles.");
        } else {
          alert("Access check failed.");
        }
        await loadSources();
      }

      async function checkAllSources() {
        if (!state.currentProject) return;
        dom.checkAll.disabled = true;
        dom.checkAllSpinner.classList.remove("hidden");
        const originalLabel = dom.checkAll.textContent;
        dom.checkAll.textContent = "Checking...";
        try {
          const result = await api(`/api/projects/${state.currentProject.id}/check-access?sample=6`, {
            method: "POST"
          });
          const flagged = result.flagged || 0;
          const checked = result.checked || 0;
          if (flagged > 0) {
            alert(`Login detected for ${flagged} / ${checked} sources. See Auth column.`);
          } else {
            alert(`Access looks OK for ${checked} sources.`);
          }
        } finally {
          dom.checkAll.disabled = false;
          dom.checkAllSpinner.classList.add("hidden");
          dom.checkAll.textContent = originalLabel;
          await loadSources();
        }
      }

      async function runPipeline() {
        if (!state.currentProject) return;
        dom.runPipeline.disabled = true;
        dom.runPipelineSpinner.classList.remove("hidden");
        const status = dom.pipelineStatus;
        status.textContent = "Running pipeline...";
        try {
          const result = await api(`/api/projects/${state.currentProject.id}/pipeline`, {
            method: "POST"
          });
          const r = result.results || {};
          status.textContent = `Done. ingest=${r.ingest || 0}, extract=${r.extract || 0}, judge=${r.judge || 0}, dedupe=${r.dedupe || 0}, unusable=${r.unusable || 0}. Check Articles & Scores.`;
        } catch (err) {
          console.error(err);
          status.textContent = "Pipeline failed. Check server logs.";
        } finally {
          dom.runPipeline.disabled = false;
          dom.runPipelineSpinner.classList.add("hidden");
          await Promise.all([loadSources(), loadArticles()]);
        }
      }

      async function editSource(sourceId) {
        const current = state.sources.find((s) => s.id === sourceId);
        const value = prompt(
          "Scrape interval (hours)",
          current?.scrape_interval_hours || ""
        );
        if (value === null) return;
        const parsed = parsePositiveNumber(value, "Scrape interval");
        if (parsed === undefined) return;
        await api(`/api/sources/${sourceId}`, {
          method: "PATCH",
          body: JSON.stringify({ scrape_interval_hours: parsed })
        });
        await loadSources();
      }

      function closeItemsPanel() {
        const existing = dom.sources.querySelector("tr.items-row");
        if (existing) existing.remove();
        state.currentSource = null;
      }

      function closeAuthPanel() {
        const existing = dom.sources.querySelector("tr.auth-row");
        if (existing) existing.remove();
        state.currentAuthSource = null;
      }

      function closeInlinePanels() {
        closeItemsPanel();
        closeAuthPanel();
      }

      function buildItemsPanel(items) {
        const cards = items
          .map((item) => {
            const title = escapeHtml(item.title || "Untitled");
            const url = escapeHtml(item.url || "");
            const content = escapeHtml(item.content || "");
            const published = formatDate(item.published_at) || "-";
            const scraped = formatDate(item.scraped_at) || "-";
            return `
              <div class="item-card">
                <div><strong>${title}</strong></div>
                <div class="meta">
                  <span>${published !== "-" ? `Published: ${published}` : `Scraped: ${scraped}`}</span>
                  <a href="${url}" target="_blank" rel="noopener noreferrer">Open link</a>
                </div>
                <div class="excerpt">${content}</div>
              </div>
            `;
          })
          .join("");
        return `
          <div class="items-panel">
            <div class="items-grid">${cards}</div>
          </div>
        `;
      }

      async function loadItems(sourceId) {
        const currentRow = dom.sources.querySelector(`tr[data-source-id="${sourceId}"]`);
        if (!currentRow) return;
        if (state.currentSource === sourceId) {
          closeItemsPanel();
          return;
        }
        closeInlinePanels();
        state.currentSource = sourceId;
        const items = await api(`/api/sources/${sourceId}/items?limit=10`);
        const row = document.createElement("tr");
        row.className = "items-row";
        if (!items.length) {
          row.innerHTML = `<td colspan="8"><div class="items-panel muted small">No items yet.</div></td>`;
        } else {
          row.innerHTML = `<td colspan="8">${buildItemsPanel(items)}</td>`;
        }
        currentRow.parentNode.insertBefore(row, currentRow.nextSibling);
      }

      function renderArticles(rows, total) {
        dom.articles.innerHTML = "";
        if (!rows.length) {
          dom.articles.innerHTML = "<tr><td colspan='5' class='small muted'>No articles yet.</td></tr>";
          dom.articlesPage.textContent = "0 / 0";
          return;
        }
        const sorted = [...rows];
        sorted.forEach((a) => {
          const tr = document.createElement("tr");
          const title = escapeHtml(a.title || "Untitled");
          const score = a.judge_score ?? "-";
          const status = a.unusable
            ? `unusable${a.unusable_reason ? ` (${escapeHtml(a.unusable_reason)})` : ""}`
            : a.scored
              ? "scored"
              : a.processed
                ? "processed"
                : "new";
          tr.innerHTML = `
            <td>${title}</td>
            <td class="small">${score}</td>
            <td class="small">${ageLabel(a.scraped_at)}</td>
            <td class="small">${status}</td>
            <td class="small">${a.used_in_audio ? "audio" : "-"}</td>
          `;
          dom.articles.appendChild(tr);
        });
        const totalPages = Math.max(1, Math.ceil((total || rows.length) / state.articlesLimit));
        const currentPage = Math.floor(state.articlesOffset / state.articlesLimit) + 1;
        dom.articlesPage.textContent = `${currentPage} / ${totalPages}`;
        dom.articlesPrev.disabled = currentPage <= 1;
        dom.articlesNext.disabled = currentPage >= totalPages;
      }

      async function loadArticles() {
        if (!state.currentProject) return;
        const order = dom.articlesOrder.value;
        const direction = dom.articlesDirection.value;
        const limit = state.articlesLimit;
        const offset = state.articlesOffset;
        const result = await api(
          `/api/projects/${state.currentProject.id}/articles?limit=${limit}&offset=${offset}&order_by=${order}&direction=${direction}`
        );
        const rows = result.items || [];
        renderArticles(rows, result.total || rows.length);
      }

      function buildAuthPanel(source) {
        const cfg = source.config || {};
        const authRequired = Boolean(cfg.auth_required);
        const authType = cfg.auth_type || "none";
        const username = cfg.auth_username || "";
        const password = cfg.auth_password || "";
        const cookie = cfg.auth_cookie || "";
        const headerName = cfg.auth_header_name || "";
        const headerValue = cfg.auth_header_value || "";
        return `
          <div class="auth-panel">
            <div class="row">
              <label class="small"><input type="checkbox" data-field="auth_required" ${authRequired ? "checked" : ""} /> Requires login</label>
              <select data-field="auth_type">
                <option value="none"${authType === "none" ? " selected" : ""}>none</option>
                <option value="basic"${authType === "basic" ? " selected" : ""}>basic</option>
                <option value="cookie"${authType === "cookie" ? " selected" : ""}>cookie</option>
                <option value="header"${authType === "header" ? " selected" : ""}>header</option>
              </select>
            </div>
            <div class="row">
              <input data-field="auth_username" placeholder="Username" value="${escapeHtml(username)}" />
              <input data-field="auth_password" type="password" placeholder="Password" value="${escapeHtml(password)}" />
            </div>
            <div class="row">
              <input data-field="auth_cookie" placeholder="Cookie header (optional)" value="${escapeHtml(cookie)}" style="flex: 1 1 320px;" />
            </div>
            <div class="row">
              <input data-field="auth_header_name" placeholder="Header name" value="${escapeHtml(headerName)}" />
              <input data-field="auth_header_value" placeholder="Header value" value="${escapeHtml(headerValue)}" />
            </div>
            <div class="row">
              <button class="primary" data-action="save-auth" data-id="${source.id}">Save Login</button>
              <button class="secondary" data-action="cancel-auth" data-id="${source.id}">Cancel</button>
            </div>
            <div class="small muted">Credentials are stored in source config (plain text).</div>
          </div>
        `;
      }

      async function openAuthPanel(sourceId) {
        const currentRow = dom.sources.querySelector(`tr[data-source-id="${sourceId}"]`);
        if (!currentRow) return;
        if (state.currentAuthSource === sourceId) {
          closeAuthPanel();
          return;
        }
        closeInlinePanels();
        state.currentAuthSource = sourceId;
        const source = state.sources.find((s) => s.id === sourceId);
        if (!source) return;
        const row = document.createElement("tr");
        row.className = "auth-row";
        row.innerHTML = `<td colspan="8">${buildAuthPanel(source)}</td>`;
        currentRow.parentNode.insertBefore(row, currentRow.nextSibling);
      }

      async function saveAuthConfig(sourceId, row) {
        const source = state.sources.find((s) => s.id === sourceId);
        if (!source) return;
        const cfg = { ...(source.config || {}) };
        const getField = (name) => row.querySelector(`[data-field="${name}"]`);
        const required = Boolean(getField("auth_required")?.checked);
        const authType = getField("auth_type")?.value || "none";
        const username = getField("auth_username")?.value.trim() || "";
        const password = getField("auth_password")?.value || "";
        const cookie = getField("auth_cookie")?.value.trim() || "";
        const headerName = getField("auth_header_name")?.value.trim() || "";
        const headerValue = getField("auth_header_value")?.value || "";

        cfg.auth_required = required;
        cfg.auth_type = authType;
        cfg.auth_username = username || null;
        cfg.auth_password = password || null;
        cfg.auth_cookie = cookie || null;
        cfg.auth_header_name = headerName || null;
        cfg.auth_header_value = headerValue || null;

        await api(`/api/sources/${sourceId}`, {
          method: "PATCH",
          body: JSON.stringify({ config: cfg })
        });
        await loadSources();
      }

      async function loadYoutube() {
        if (!state.currentProject) return;
        const info = await api(`/api/projects/${state.currentProject.id}/youtube`);
        const status = dom.ytStatus;
        if (info && info.refresh_token) {
          status.textContent = `Saved token for: ${info.channel_title || "Unknown channel"}`;
          status.classList.remove("warn");
        } else {
          status.textContent = "No YouTube token stored yet.";
          status.classList.add("warn");
        }
      }

      async function saveYoutube() {
        if (!state.currentProject) return;
        const refresh_token = dom.ytToken.value.trim();
        const channel_title = dom.ytChannel.value.trim();
        if (!refresh_token) return;
        await api(`/api/projects/${state.currentProject.id}/youtube`, {
          method: "POST",
          body: JSON.stringify({ refresh_token, channel_title })
        });
        dom.ytToken.value = "";
        await loadYoutube();
      }

      async function generateRoundup() {
        if (!state.currentProject) return;
        const status = dom.roundupStatus;
        status.textContent = "Generating script...";
        try {
          const result = await api(`/api/projects/${state.currentProject.id}/audio-roundup`, {
            method: "POST"
          });
          if (result.status !== "ok") {
            status.textContent = "No items available for roundup.";
            state.currentRoundup = null;
            dom.roundupAudio.removeAttribute("src");
            dom.roundupVideo.removeAttribute("src");
            dom.roundupVideo.style.display = "none";
            dom.roundupImage.removeAttribute("src");
            dom.roundupImage.style.display = "none";
            return;
          }
          state.currentRoundup = result.post;
          status.textContent = "Script ready. Render audio when ready.";
          await loadRoundupImage(true);
        } catch (err) {
          console.error(err);
          status.textContent = "Failed to generate script.";
        }
      }

      async function loadRoundupImage(refresh = false) {
        if (!state.currentRoundup?.id) return;
        const img = dom.roundupImage;
        const base = `/api/audio-roundup/${state.currentRoundup.id}/image`;
        const url = refresh ? `${base}?refresh=1` : base;
        img.onload = () => {
          img.style.display = "block";
        };
        img.onerror = () => {
          img.style.display = "none";
        };
        img.src = `${url}${url.includes("?") ? "&" : "?"}t=${Date.now()}`;
      }

      async function renderRoundup() {
        if (!state.currentRoundup?.id) {
          alert("Generate a script first.");
          return;
        }
        const status = dom.roundupStatus;
        status.textContent = "Rendering audio...";
        try {
          const result = await api(`/api/audio-roundup/${state.currentRoundup.id}/render`, {
            method: "POST"
          });
          dom.roundupAudio.src = `${result.url}?t=${Date.now()}`;
          dom.roundupAudio.play().catch(() => {});
          status.textContent = "Audio ready.";
        } catch (err) {
          console.error(err);
          status.textContent = "Failed to render audio. Check TTS + ffmpeg.";
        }
      }

      async function renderRoundupVideo() {
        if (!state.currentRoundup?.id) {
          alert("Generate a script first.");
          return;
        }
        const status = dom.roundupStatus;
        status.textContent = "Rendering video...";
        try {
          const result = await api(`/api/audio-roundup/${state.currentRoundup.id}/render-video`, {
            method: "POST"
          });
          dom.roundupVideo.src = `${result.url}?t=${Date.now()}`;
          dom.roundupVideo.style.display = "block";
          status.textContent = "Video ready.";
        } catch (err) {
          console.error(err);
          status.textContent = "Failed to render video. Check image generation + ffmpeg.";
        }
      }

      async function saveProjectSettings() {
        if (!state.currentProject) return;
        const language = dom.projectLanguage.value;
        const genRaw = dom.projectGenInterval.value.trim();
        const genInterval = parsePositiveNumber(genRaw, "Generation interval");
        if (genInterval === undefined) return;
        const scoreRaw = dom.projectUnusableScore.value.trim();
        const unusableScore = parseScore(scoreRaw, "Unusable score threshold");
        if (unusableScore === undefined) return;
        const ageRaw = dom.projectUnusableAge.value.trim();
        const unusableAge = parsePositiveNumber(ageRaw, "Unusable age hours");
        if (unusableAge === undefined) return;
        await api(`/api/projects/${state.currentProject.id}`, {
          method: "PATCH",
          body: JSON.stringify({
            language: language || null,
            generation_interval_hours: genInterval,
            unusable_score_threshold: unusableScore,
            unusable_age_hours: unusableAge
          })
        });
        await loadProjects();
      }

      async function deleteProject() {
        if (!state.currentProject) return;
        const name = state.currentProject.name || "this project";
        const ok = confirm(`Delete ${name}? This will remove its sources and items.`);
        if (!ok) return;
        await api(`/api/projects/${state.currentProject.id}`, { method: "DELETE" });
        state.currentProject = null;
        dom.projectLabel.textContent = "No project selected";
        dom.projectLanguage.value = "";
        dom.projectGenInterval.value = "";
        dom.projectUnusableScore.value = "";
        dom.projectUnusableAge.value = "";
        closeInlinePanels();
        dom.articles.innerHTML = "<tr><td colspan='5' class='small muted'>No project selected.</td></tr>";
        renderProjectSummary(null);
        await loadProjects();
      }

      dom.sources.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) return;
        const { action, id } = button.dataset;
        if (!id) return;
        if (action === "scrape") {
          scrapeSource(id);
        } else if (action === "view") {
          loadItems(id);
        } else if (action === "login") {
          openAuthPanel(id);
        } else if (action === "edit") {
          editSource(id);
        } else if (action === "save-auth") {
          const row = button.closest("tr.auth-row");
          if (!row) return;
          saveAuthConfig(id, row);
        } else if (action === "cancel-auth") {
          closeAuthPanel();
        }
      });

      dom.createProject.onclick = addProject;
      dom.addSource.onclick = addSource;
      dom.scrapeAll.onclick = scrapeAll;
      dom.checkAll.onclick = checkAllSources;
      dom.runPipeline.onclick = runPipeline;
      dom.articlesLimit.onchange = () => {
        state.articlesLimit = Number(dom.articlesLimit.value);
        state.articlesOffset = 0;
        loadArticles();
      };
      dom.articlesOrder.onchange = () => {
        state.articlesOffset = 0;
        loadArticles();
      };
      dom.articlesDirection.onchange = () => {
        state.articlesOffset = 0;
        loadArticles();
      };
      dom.articlesPrev.onclick = () => {
        state.articlesOffset = Math.max(0, state.articlesOffset - state.articlesLimit);
        loadArticles();
      };
      dom.articlesNext.onclick = () => {
        state.articlesOffset = state.articlesOffset + state.articlesLimit;
        loadArticles();
      };
      dom.saveYoutube.onclick = saveYoutube;
      dom.saveProject.onclick = saveProjectSettings;
      dom.deleteProject.onclick = deleteProject;
      dom.generateRoundup.onclick = generateRoundup;
      dom.renderRoundup.onclick = renderRoundup;
      dom.renderRoundupVideo.onclick = renderRoundupVideo;
      dom.refresh.onclick = loadProjects;
      dom.refreshArticles.onclick = loadArticles;

      document.addEventListener("click", (event) => {
        if (!state.currentSource && !state.currentAuthSource) return;
        const withinItems = event.target.closest("tr.items-row");
        const withinAuth = event.target.closest("tr.auth-row");
        const withinViewButton = event.target.closest("button[data-action='view']");
        const withinLoginButton = event.target.closest("button[data-action='login']");
        if (!withinItems && !withinAuth && !withinViewButton && !withinLoginButton) {
          closeInlinePanels();
        }
      });

      loadProjects().catch((err) => {
        console.error(err);
        alert("Failed to load. Check API and Supabase config.");
      });
    </script>
  </body>
</html>
