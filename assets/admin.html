<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OnePlace Admin</title>
    <style>
      :root {
        --bg: #f3efe4;
        --panel: #fffdf7;
        --ink: #2a2a2a;
        --muted: #6d6257;
        --accent: #2f6f6d;
        --accent-2: #b84e4e;
        --border: #e4dccd;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Georgia, "Times New Roman", serif;
        color: var(--ink);
        background: radial-gradient(circle at 20% 20%, #f8f4ea 0%, var(--bg) 60%);
      }
      header {
        padding: 18px 24px;
        border-bottom: 1px solid var(--border);
        background: #f9f6ee;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      header h1 {
        margin: 0;
        font-size: 22px;
        letter-spacing: 0.4px;
      }
      main {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 16px;
        padding: 16px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
      }
      .panel h2 {
        margin: 0 0 8px;
        font-size: 16px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .projects-list button {
        width: 100%;
        text-align: left;
        padding: 8px 10px;
        margin-bottom: 6px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
      }
      .projects-list button.active {
        border-color: var(--accent);
        background: #e8f1f0;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      input, select, textarea {
        padding: 6px 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-family: inherit;
      }
      textarea {
        width: 100%;
        min-height: 80px;
      }
      button.primary {
        background: var(--accent);
        color: white;
        border: 0;
        border-radius: 8px;
        padding: 8px 10px;
        cursor: pointer;
      }
      button.secondary {
        background: #f2e7da;
        color: #3a2f26;
        border: 0;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th, td {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid var(--border);
      }
      .muted {
        color: var(--muted);
      }
      .status-pill {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 12px;
        background: #efe7da;
      }
      .items {
        max-height: 240px;
        overflow: auto;
        border: 1px dashed var(--border);
        padding: 8px;
        border-radius: 8px;
        background: #fff;
      }
      .items .item {
        padding: 6px 0;
        border-bottom: 1px solid var(--border);
      }
      .items .item:last-child {
        border-bottom: none;
      }
      .small {
        font-size: 12px;
      }
      .warn {
        color: var(--accent-2);
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>OnePlace Admin</h1>
      <button class="secondary" id="refresh">Refresh</button>
    </header>
    <main>
      <section class="panel">
        <h2>Projects</h2>
        <div class="projects-list" id="projects"></div>
        <div class="row">
          <input id="projectName" placeholder="Project name" />
          <button class="primary" id="createProject">Add</button>
        </div>
        <div class="row" style="margin-top: 8px;">
          <select id="projectLanguage">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="sk">Slovakian</option>
          </select>
          <input
            id="projectGenInterval"
            type="number"
            min="1"
            step="1"
            placeholder="Generate hrs"
            style="max-width: 140px;"
          />
          <button class="secondary" id="saveProject">Save Settings</button>
          <button class="secondary" id="deleteProject">Delete Project</button>
        </div>
        <div class="small muted">One project = one topic or channel.</div>
      </section>

      <section class="panel">
        <h2>Sources</h2>
        <div class="row">
          <button class="primary" id="scrapeAll">Scrape All</button>
          <span class="small muted" id="projectLabel">No project selected</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>URL</th>
              <th>Last</th>
              <th>Every (hrs)</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="sources"></tbody>
        </table>
        <div class="row" style="margin-top: 8px;">
          <input id="sourceName" placeholder="Source name" />
          <select id="sourceType">
            <option value="rss">rss</option>
            <option value="page">page</option>
            <option value="reddit">reddit</option>
            <option value="youtube">youtube</option>
          </select>
          <input id="sourceUrl" placeholder="https://..." style="flex: 1 1 260px;" />
          <input
            id="sourceInterval"
            type="number"
            min="1"
            step="1"
            placeholder="Scrape hrs"
            style="max-width: 120px;"
          />
          <button class="primary" id="addSource">Add Source</button>
        </div>
        <div class="small muted">For YouTube: use channel RSS URL. For Reddit: use /r/name/.rss</div>
      </section>

      <section class="panel">
        <h2>Latest Items</h2>
        <div class="items" id="items">
          <div class="muted small">Select a source to see recent items.</div>
        </div>
      </section>

      <section class="panel">
        <h2>YouTube (V1)</h2>
        <div class="small muted">Store a refresh token per project (OAuth setup later).</div>
        <div class="row" style="margin-top: 8px;">
          <input id="ytChannel" placeholder="Channel title (optional)" />
          <input id="ytToken" placeholder="Refresh token" style="flex: 1 1 260px;" />
          <button class="primary" id="saveYoutube">Save</button>
        </div>
        <div id="ytStatus" class="small muted"></div>
      </section>

      <section class="panel">
        <h2>Audio Roundup</h2>
        <div class="small muted">Generate script in project language, then render audio (TTS + ffmpeg required).</div>
        <div class="row" style="margin-top: 8px;">
          <button class="primary" id="generateRoundup">Generate Script</button>
          <button class="secondary" id="renderRoundup">Render Audio</button>
          <div id="roundupStatus" class="small muted"></div>
        </div>
        <audio id="roundupAudio" controls style="width: 100%; margin-top: 8px;"></audio>
      </section>
    </main>
    <script>
      const state = {
        projects: [],
        sources: [],
        currentProject: null,
        currentSource: null,
        currentRoundup: null
      };
      const dom = {
        projects: document.getElementById("projects"),
        projectName: document.getElementById("projectName"),
        projectLanguage: document.getElementById("projectLanguage"),
        projectGenInterval: document.getElementById("projectGenInterval"),
        projectLabel: document.getElementById("projectLabel"),
        sources: document.getElementById("sources"),
        sourceName: document.getElementById("sourceName"),
        sourceType: document.getElementById("sourceType"),
        sourceUrl: document.getElementById("sourceUrl"),
        sourceInterval: document.getElementById("sourceInterval"),
        items: document.getElementById("items"),
        ytChannel: document.getElementById("ytChannel"),
        ytToken: document.getElementById("ytToken"),
        ytStatus: document.getElementById("ytStatus"),
        roundupStatus: document.getElementById("roundupStatus"),
        roundupAudio: document.getElementById("roundupAudio"),
        createProject: document.getElementById("createProject"),
        addSource: document.getElementById("addSource"),
        scrapeAll: document.getElementById("scrapeAll"),
        saveYoutube: document.getElementById("saveYoutube"),
        saveProject: document.getElementById("saveProject"),
        deleteProject: document.getElementById("deleteProject"),
        generateRoundup: document.getElementById("generateRoundup"),
        renderRoundup: document.getElementById("renderRoundup"),
        refresh: document.getElementById("refresh")
      };

      async function api(path, options = {}) {
        const res = await fetch(path, {
          headers: { "Content-Type": "application/json" },
          ...options
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || res.statusText);
        }
        return res.headers.get("content-type")?.includes("application/json")
          ? res.json()
          : res.text();
      }

      function escapeHtml(value) {
        return String(value ?? "").replace(/[&<>"']/g, (char) => {
          const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;"
          };
          return map[char] || char;
        });
      }

      function formatDate(value) {
        return value ? value.split("T")[0] : "-";
      }

      function parsePositiveNumber(raw, label) {
        if (raw === "") return null;
        const parsed = Number(raw);
        if (!Number.isFinite(parsed) || parsed <= 0) {
          alert(`${label} must be a number > 0.`);
          return undefined;
        }
        return parsed;
      }

      function renderProjects() {
        dom.projects.innerHTML = "";
        state.projects.forEach((p) => {
          const btn = document.createElement("button");
          btn.textContent = p.name;
          if (state.currentProject && state.currentProject.id === p.id) {
            btn.classList.add("active");
          }
          btn.onclick = () => selectProject(p);
          dom.projects.appendChild(btn);
        });
      }

      function renderSources() {
        dom.sources.innerHTML = "";
        state.sources.forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(s.name)}</td>
            <td>${escapeHtml(s.source_type)}</td>
            <td class="small">${escapeHtml(s.url)}</td>
            <td class="small">${formatDate(s.last_scraped_at)}</td>
            <td class="small">${s.scrape_interval_hours ?? "-"}</td>
            <td><span class="status-pill">${escapeHtml(s.last_status || "idle")}</span></td>
            <td>
              <button class="secondary" data-action="scrape" data-id="${s.id}">Scrape</button>
              <button class="secondary" data-action="view" data-id="${s.id}">View</button>
              <button class="secondary" data-action="edit" data-id="${s.id}">Edit</button>
            </td>
          `;
          dom.sources.appendChild(tr);
        });
      }

      async function loadProjects() {
        state.projects = await api("/api/projects");
        if (state.currentProject) {
          const match = state.projects.find((p) => p.id === state.currentProject.id);
          state.currentProject = match || null;
        }
        if (!state.currentProject && state.projects.length) {
          await selectProject(state.projects[0]);
          return;
        }
        renderProjects();
        if (state.currentProject) {
          dom.projectLabel.textContent = state.currentProject.name;
          await Promise.all([loadSources(), loadYoutube()]);
        } else {
          dom.projectLabel.textContent = "No project selected";
          dom.sources.innerHTML = "";
          dom.items.innerHTML = "<div class='muted small'>Select a source to see recent items.</div>";
        }
      }

      async function selectProject(project) {
        state.currentProject = project;
        dom.projectLabel.textContent = project.name;
        const langValue = ["en", "es", "sk"].includes(project.language)
          ? project.language
          : "en";
        dom.projectLanguage.value = langValue;
        dom.projectGenInterval.value = project.generation_interval_hours || "";
        renderProjects();
        await Promise.all([loadSources(), loadYoutube()]);
      }

      async function loadSources() {
        if (!state.currentProject) return;
        state.sources = await api(`/api/projects/${state.currentProject.id}/sources`);
        renderSources();
      }

      async function addProject() {
        const name = dom.projectName.value.trim();
        if (!name) return;
        await api("/api/projects", { method: "POST", body: JSON.stringify({ name }) });
        dom.projectName.value = "";
        await loadProjects();
      }

      async function addSource() {
        if (!state.currentProject) return;
        const name = dom.sourceName.value.trim();
        const source_type = dom.sourceType.value;
        const url = dom.sourceUrl.value.trim();
        const intervalRaw = dom.sourceInterval.value.trim();
        const scrape_interval_hours = parsePositiveNumber(intervalRaw, "Scrape interval");
        if (scrape_interval_hours === undefined) return;
        if (!name || !url) return;
        await api(`/api/projects/${state.currentProject.id}/sources`, {
          method: "POST",
          body: JSON.stringify({
            name,
            source_type,
            url,
            enabled: true,
            scrape_interval_hours
          })
        });
        dom.sourceName.value = "";
        dom.sourceUrl.value = "";
        dom.sourceInterval.value = "";
        await loadSources();
      }

      async function scrapeAll() {
        if (!state.currentProject) return;
        await api(`/api/projects/${state.currentProject.id}/scrape`, { method: "POST" });
        await loadSources();
      }

      async function scrapeSource(sourceId) {
        await api(`/api/sources/${sourceId}/scrape`, { method: "POST" });
        await loadSources();
      }

      async function editSource(sourceId) {
        const current = state.sources.find((s) => s.id === sourceId);
        const value = prompt(
          "Scrape interval (hours)",
          current?.scrape_interval_hours || ""
        );
        if (value === null) return;
        const parsed = parsePositiveNumber(value, "Scrape interval");
        if (parsed === undefined) return;
        await api(`/api/sources/${sourceId}`, {
          method: "PATCH",
          body: JSON.stringify({ scrape_interval_hours: parsed })
        });
        await loadSources();
      }

      async function loadItems(sourceId) {
        state.currentSource = sourceId;
        const items = await api(`/api/sources/${sourceId}/items?limit=10`);
        if (!items.length) {
          dom.items.innerHTML = "<div class='muted small'>No items yet.</div>";
          return;
        }
        dom.items.innerHTML = items
          .map((item) => {
            const title = escapeHtml(item.title || "Untitled");
            const url = escapeHtml(item.url || "");
            const content = escapeHtml((item.content || "").slice(0, 220));
            return `
              <div class="item">
                <div><strong>${title}</strong></div>
                <div class="small muted">${url}</div>
                <div class="small">${content}</div>
              </div>
            `;
          })
          .join("");
      }

      async function loadYoutube() {
        if (!state.currentProject) return;
        const info = await api(`/api/projects/${state.currentProject.id}/youtube`);
        const status = dom.ytStatus;
        if (info && info.refresh_token) {
          status.textContent = `Saved token for: ${info.channel_title || "Unknown channel"}`;
          status.classList.remove("warn");
        } else {
          status.textContent = "No YouTube token stored yet.";
          status.classList.add("warn");
        }
      }

      async function saveYoutube() {
        if (!state.currentProject) return;
        const refresh_token = dom.ytToken.value.trim();
        const channel_title = dom.ytChannel.value.trim();
        if (!refresh_token) return;
        await api(`/api/projects/${state.currentProject.id}/youtube`, {
          method: "POST",
          body: JSON.stringify({ refresh_token, channel_title })
        });
        dom.ytToken.value = "";
        await loadYoutube();
      }

      async function generateRoundup() {
        if (!state.currentProject) return;
        const status = dom.roundupStatus;
        status.textContent = "Generating script...";
        try {
          const result = await api(`/api/projects/${state.currentProject.id}/audio-roundup`, {
            method: "POST"
          });
          if (result.status !== "ok") {
            status.textContent = "No items available for roundup.";
            state.currentRoundup = null;
            dom.roundupAudio.removeAttribute("src");
            return;
          }
          state.currentRoundup = result.post;
          status.textContent = "Script ready. Render audio when ready.";
        } catch (err) {
          console.error(err);
          status.textContent = "Failed to generate script.";
        }
      }

      async function renderRoundup() {
        if (!state.currentRoundup?.id) {
          alert("Generate a script first.");
          return;
        }
        const status = dom.roundupStatus;
        status.textContent = "Rendering audio...";
        try {
          const result = await api(`/api/audio-roundup/${state.currentRoundup.id}/render`, {
            method: "POST"
          });
          dom.roundupAudio.src = `${result.url}?t=${Date.now()}`;
          dom.roundupAudio.play().catch(() => {});
          status.textContent = "Audio ready.";
        } catch (err) {
          console.error(err);
          status.textContent = "Failed to render audio. Check TTS + ffmpeg.";
        }
      }

      async function saveProjectSettings() {
        if (!state.currentProject) return;
        const language = dom.projectLanguage.value;
        const genRaw = dom.projectGenInterval.value.trim();
        const genInterval = parsePositiveNumber(genRaw, "Generation interval");
        if (genInterval === undefined) return;
        await api(`/api/projects/${state.currentProject.id}`, {
          method: "PATCH",
          body: JSON.stringify({
            language: language || null,
            generation_interval_hours: genInterval
          })
        });
        await loadProjects();
      }

      async function deleteProject() {
        if (!state.currentProject) return;
        const name = state.currentProject.name || "this project";
        const ok = confirm(`Delete ${name}? This will remove its sources and items.`);
        if (!ok) return;
        await api(`/api/projects/${state.currentProject.id}`, { method: "DELETE" });
        state.currentProject = null;
        dom.projectLabel.textContent = "No project selected";
        dom.projectLanguage.value = "";
        dom.projectGenInterval.value = "";
        dom.items.innerHTML = "<div class='muted small'>Select a source to see recent items.</div>";
        await loadProjects();
      }

      dom.sources.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) return;
        const { action, id } = button.dataset;
        if (!id) return;
        if (action === "scrape") {
          scrapeSource(id);
        } else if (action === "view") {
          loadItems(id);
        } else if (action === "edit") {
          editSource(id);
        }
      });

      dom.createProject.onclick = addProject;
      dom.addSource.onclick = addSource;
      dom.scrapeAll.onclick = scrapeAll;
      dom.saveYoutube.onclick = saveYoutube;
      dom.saveProject.onclick = saveProjectSettings;
      dom.deleteProject.onclick = deleteProject;
      dom.generateRoundup.onclick = generateRoundup;
      dom.renderRoundup.onclick = renderRoundup;
      dom.refresh.onclick = loadProjects;

      loadProjects().catch((err) => {
        console.error(err);
        alert("Failed to load. Check API and Supabase config.");
      });
    </script>
  </body>
</html>
